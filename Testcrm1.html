<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page de Suivi des Deals (CRM)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #history-modal, #comment-history { white-space: pre-wrap; }
        /* Transition douce pour l'apparition des champs */
        #closing-details { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="container mx-auto p-4 sm:p-8">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">Page de Suivi des Deals de Vente</h1>
            <p class="text-gray-500">Vue filtr√©e et nettoy√©e des donn√©es Google Sheet.</p>
            <p class="text-xs text-green-600 font-semibold mt-2" id="app-script-warning">
                ‚úÖ URL Apps Script configur√©e.
            </p>
        </header>
        
        <!-- DASHBOARD -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500">
                <p class="text-sm font-medium text-gray-500">Deals (Vue Actuelle)</p>
                <p id="metric-total" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-indigo-500">
                <p class="text-sm font-medium text-gray-500">√Ä Follow Up (Vue Actuelle)</p>
                <p id="metric-followup" class="text-2xl font-bold text-indigo-700">0</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500">
                <p id="metric-closed-label" class="text-sm font-medium text-gray-500">Clos√©s (Vue Actuelle)</p>
                <p id="metric-closed" class="text-2xl font-bold text-green-700">0</p>
            </div>
        </div>

        <!-- Formulaire d'ajout -->
        <div class="bg-white shadow-xl rounded-2xl p-6 mb-8 border border-blue-100">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4" id="form-title">Ajouter un Nouveau Deal</h2>
            <form id="deal-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Donn√©es principales -->
                <div><label for="nomPrenom" class="block text-sm font-medium text-gray-700">Nom Pr√©nom *</label><input type="text" id="nomPrenom" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                <div><label for="source" class="block text-sm font-medium text-gray-700">Source (A) *</label><select id="source" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white transition duration-150"><option value="">S√©lectionner...</option><option value="Marketing">Marketing</option><option value="Setting">Setting</option><option value="Prise de rdv">Prise de RDV</option><option value="Autre">Autre</option></select></div>
                <div><label for="entrepreneur" class="block text-sm font-medium text-gray-700">Entrepreneur (F)</label><input type="text" id="entrepreneur" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Nom de l'entrepreneur"></div>

                <div><label for="dateRDV" class="block text-sm font-medium text-gray-700">Date RDV / Dernier Suivi</label><input type="date" id="dateRDV" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                <div><label for="email" class="block text-sm font-medium text-gray-700">Adresse Email (C)</label><input type="email" id="email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                <div><label for="numero" class="block text-sm font-medium text-gray-700">Num√©ro (D)</label><input type="text" id="numero" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g. 0612345678"></div>
                
                <div class="md:col-span-3"><label for="enregistrementCall" class="block text-sm font-medium text-gray-700">Lien Enregistrement du call (R)</label><input type="url" id="enregistrementCall" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="https://lien.vers.appel"></div>

                <!-- Checkboxes -->
                <div class="md:col-span-3 border-t pt-4 mt-2">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Statuts et Flags</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                        <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg shadow-sm border hover:border-blue-400 cursor-pointer transition"><input type="checkbox" id="ghost" class="h-5 w-5 text-yellow-600 rounded border-gray-300 focus:ring-yellow-500"><span class="text-sm font-medium text-gray-700">Ghost (G)</span></label>
                        <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg shadow-sm border hover:border-blue-400 cursor-pointer transition"><input type="checkbox" id="aFollowUp" class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"><span class="text-sm font-medium text-gray-700">√Ä Follow Up (H)</span></label>
                        <label class="flex items-center space-x-2 p-3 bg-red-50 rounded-lg shadow-sm border border-red-200 hover:border-red-400 cursor-pointer transition"><input type="checkbox" id="nonClose" class="h-5 w-5 text-red-600 rounded border-gray-300 focus:ring-red-500"><span class="text-sm font-medium text-gray-700">Non Clos√© (I)</span></label>
                        
                        <!-- La case CLOS√â contr√¥le l'affichage des d√©tails -->
                        <label class="flex items-center space-x-2 p-3 bg-green-50 rounded-lg shadow-sm border-2 border-green-200 hover:border-green-500 cursor-pointer transition ring-offset-2 focus-within:ring-2 ring-green-500">
                            <input type="checkbox" id="close" class="h-5 w-5 text-green-600 rounded border-gray-300 focus:ring-green-500">
                            <span class="text-sm font-bold text-green-800">Clos√© (J)</span>
                        </label>
                        
                        <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg shadow-sm border hover:border-blue-400 cursor-pointer transition"><input type="checkbox" id="compta" class="h-5 w-5 text-teal-600 rounded border-gray-300 focus:ring-teal-500"><span class="text-sm font-medium text-gray-700">Compta ? (P)</span></label>
                    </div>
                </div>

                <!-- SECTION D√âTAILS CLOSING (Masqu√©e par d√©faut) -->
                <div id="closing-details" class="md:col-span-3 hidden border-l-4 border-green-500 pl-4 bg-green-50 rounded-r-lg py-4 pr-4 mt-2">
                    <h3 class="text-lg font-semibold text-green-800 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        D√©tails de la Vente
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="formation" class="block text-sm font-medium text-green-900">Formation / Produit (L)</label><select id="formation" class="mt-1 block w-full px-4 py-2 border border-green-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 bg-white"><option value="">S√©lectionner...</option><option value="Produit B 4000">Produit B 4000</option><option value="Produit A 2000">Produit A 2000</option><option value="N/A">N/A</option></select></div>
                        <div><label for="prix" class="block text-sm font-medium text-green-900">Prix (‚Ç¨) (M)</label><input type="number" id="prix" step="0.01" min="0" class="mt-1 block w-full px-4 py-2 border border-green-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"></div>
                        <div><label for="typePaiement" class="block text-sm font-medium text-green-900">Type de Paiement (N)</label><select id="typePaiement" class="mt-1 block w-full px-4 py-2 border border-green-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 bg-white"><option value="">S√©lectionner...</option><option value="CB">Carte Bancaire</option><option value="Virement">Virement</option><option value="3x">Paiement en 3x</option><option value="Int√©gral">Paiement Int√©gral</option><option value="N/A">N/A</option></select></div>
                        <div><label for="mensualite" class="block text-sm font-medium text-green-900">Mensualit√© (‚Ç¨) (O)</label><input type="number" id="mensualite" step="0.01" min="0" class="mt-1 block w-full px-4 py-2 border border-green-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500"></div>
                    </div>
                </div>

                <!-- Commentaires -->
                <div class="md:col-span-3">
                    <label for="newComment" class="block text-sm font-medium text-gray-700">Nouveau Commentaire (Q)</label>
                    <textarea id="newComment" rows="2" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Ajouter une note de suivi pour ce call..."></textarea>
                    <div id="comment-history" class="mt-4 p-3 bg-gray-100 rounded-lg text-sm hidden">
                        <p class="font-semibold text-gray-600 mb-2">Historique des commentaires (S√©par√© par `---`) :</p>
                        <div id="history-content" class="text-gray-700 max-h-40 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="md:col-span-3 flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="hidden px-6 py-2 bg-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-400 transition duration-200">Annuler</button>
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 transform hover:scale-[1.01]">
                        <span id="submit-text">Ajouter le Deal</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- FILTRES -->
        <div class="bg-white p-4 rounded-xl shadow-md mb-6 border border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label for="filter-month" class="block text-sm font-medium text-gray-700">Vue Mensuelle (Date RDV)</label>
                <select id="filter-month" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-600 focus:border-blue-600 bg-white font-semibold text-blue-900">
                    <option value="current">üìÖ Mois en cours</option>
                    <option value="all">Tout l'historique</option>
                </select>
            </div>
            <div>
                <label for="filter-status" class="block text-sm font-medium text-gray-700">Filtrer par statut</label>
                <select id="filter-status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="all">Tous les Deals</option>
                    <option value="followup">√Ä Follow Up (H)</option>
                    <option value="ghost">Ghost (G)</option>
                    <option value="closed">Clos√© (J)</option>
                    <option value="nonclosed">Non Clos√© (I)</option>
                </select>
            </div>
            <div>
                <label for="filter-source" class="block text-sm font-medium text-gray-700">Filtrer par Source (A)</label>
                <select id="filter-source" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="all">Toutes les Sources</option>
                    <option value="Marketing">Marketing</option>
                    <option value="Setting">Setting</option>
                    <option value="Prise de rdv">Prise de RDV</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div>
                <button id="reset-filters" class="w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">Tout R√©initialiser</button>
            </div>
        </div>

        <div id="loading-message" class="text-center p-8 text-gray-500">Chargement des donn√©es depuis Google Sheet...</div>
        <div id="error-message" class="text-center p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg hidden"></div>
        <div id="no-data-message" class="text-center p-8 text-gray-500 hidden">Aucun deal trouv√© pour ce mois.</div>
        
        <div class="mt-8">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Console de Debugage</h3>
            <pre id="debug-console" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-sm max-h-48">Attente de la r√©ponse de l'API...</pre>
        </div>

        <div class="bg-white shadow-xl rounded-2xl overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-blue-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact & Source</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date RDV</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit & Prix</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paiement / Mensualit√©</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Flags (G/F/C/N)</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="deals-table-body" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
        
        <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-800">Historique des Commentaires</h3>
                <div id="modal-history-content" class="max-h-80 overflow-y-auto space-y-3 p-2 bg-gray-50 rounded-lg whitespace-pre-wrap"></div>
                <div class="flex justify-end mt-4"><button id="close-modal-btn" class="px-4 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 transition duration-150">Fermer</button></div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwJjpT47S5CcDklTn79vPNTbpkvcOR00JlzdjBip_CmIcq2j3f4KmTYKX_PqI3Gg41/exec'; 

        let allDealsCache = []; 
        let editingId = null; 

        // S√©lecteurs
        const dealsTableBody = document.getElementById('deals-table-body');
        const dealForm = document.getElementById('deal-form');
        const formTitle = document.getElementById('form-title');
        const submitText = document.getElementById('submit-text');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const noDataMessage = document.getElementById('no-data-message');
        const debugConsole = document.getElementById('debug-console');
        
        const metricTotal = document.getElementById('metric-total');
        const metricFollowUp = document.getElementById('metric-followup');
        const metricClosed = document.getElementById('metric-closed');
        
        const filterMonth = document.getElementById('filter-month'); 
        const filterStatus = document.getElementById('filter-status');
        const filterSource = document.getElementById('filter-source');
        const resetFiltersBtn = document.getElementById('reset-filters');
        
        const newCommentField = document.getElementById('newComment');
        const historyModal = document.getElementById('history-modal');
        const modalHistoryContent = document.getElementById('modal-history-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        // S√©lecteurs pour la gestion d'affichage conditionnel
        const closeCheckbox = document.getElementById('close');
        const closingDetailsDiv = document.getElementById('closing-details');

        // --- Logique d'affichage dynamique (Closing) ---
        function toggleClosingDetails() {
            if (closeCheckbox.checked) {
                closingDetailsDiv.classList.remove('hidden');
                // Optionnel : ajouter une petite animation ou focus
            } else {
                closingDetailsDiv.classList.add('hidden');
                // Optionnel : vider les champs si on d√©coche ? (non recommand√© pour √©viter la perte de donn√©es accidentelle)
            }
        }

        // √âcouter le changement sur la checkbox Clos√©
        closeCheckbox.addEventListener('change', toggleClosingDetails);

        // --- API ---
        async function fetchAppsScript(action, data = null) {
            const url = APPS_SCRIPT_URL + (action === 'READ' ? '?action=READ' : '');
            debugConsole.textContent = `Tentative de ${action}...`;

            try {
                const response = await fetch(url, {
                    method: action === 'READ' ? 'GET' : 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: action !== 'READ' ? JSON.stringify({ action, data }) : null,
                });
                
                if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                const result = await response.json();
                debugConsole.textContent = `Action ${action} r√©ussie.`;
                if (!result.success) throw new Error(result.error || result.message);
                return result;

            } catch (error) {
                errorMessage.textContent = `Erreur: ${error.message}`;
                errorMessage.classList.remove('hidden');
                return { success: false, error: error.message };
            }
        }
        
        async function loadDeals() {
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            noDataMessage.classList.add('hidden');

            const result = await fetchAppsScript('READ');
            loadingMessage.classList.add('hidden');

            if (result.success) {
                allDealsCache = (result.deals || []).filter(d => d.nomPrenom && d.nomPrenom.toString().trim() !== "");
                populateMonthFilter();
                applyFiltersAndRender();
                
                if (allDealsCache.length === 0) noDataMessage.textContent = "Aucune donn√©e dans le Google Sheet.";
                if (editingId) {
                    const currentDeal = allDealsCache.find(d => d.id === editingId);
                    if (!currentDeal) resetForm();
                }
            } else {
                dealsTableBody.innerHTML = '';
            }
        }

        function populateMonthFilter() {
            filterMonth.innerHTML = '<option value="current">üìÖ Mois en cours</option><option value="all">Tout l\'historique</option>';
            const monthsSet = new Set();
            allDealsCache.forEach(deal => {
                if (deal.dateRDV) {
                    const date = new Date(deal.dateRDV);
                    if (!isNaN(date)) {
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        monthsSet.add(key);
                    }
                }
            });
            const sortedMonths = Array.from(monthsSet).sort().reverse();
            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const label = new Date(year, month - 1).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = label.charAt(0).toUpperCase() + label.slice(1);
                filterMonth.appendChild(option);
            });
        }

        function checkMonthFilter(dealDateString, filterValue) {
            if (!dealDateString) return false;
            const dealDate = new Date(dealDateString);
            const now = new Date();
            if (filterValue === 'current') return dealDate.getMonth() === now.getMonth() && dealDate.getFullYear() === now.getFullYear();
            else if (filterValue === 'all') return true;
            else {
                const [filterYear, filterMonth] = filterValue.split('-');
                return dealDate.getFullYear() == filterYear && (dealDate.getMonth() + 1) == filterMonth;
            }
        }

        function applyFiltersAndRender() {
            let filteredDeals = [...allDealsCache];
            const monthVal = filterMonth.value;
            const statusVal = filterStatus.value;
            const sourceVal = filterSource.value;

            if (monthVal !== 'all') filteredDeals = filteredDeals.filter(deal => checkMonthFilter(deal.dateRDV, monthVal));
            if (statusVal !== 'all') {
                filteredDeals = filteredDeals.filter(deal => {
                    switch (statusVal) {
                        case 'followup': return deal.aFollowUp;
                        case 'ghost': return deal.ghost;
                        case 'closed': return deal.close;
                        case 'nonclosed': return deal.nonClose;
                        default: return true;
                    }
                });
            }
            if (sourceVal !== 'all') filteredDeals = filteredDeals.filter(deal => deal.source === sourceVal);
            
            filteredDeals.sort((a, b) => {
                const aPast = a.dateRDV && isPastDate(a.dateRDV);
                const bPast = b.dateRDV && isPastDate(b.dateRDV);
                if (aPast && !bPast) return -1; 
                if (!aPast && bPast) return 1;  
                return new Date(b.dateRDV || 0) - new Date(a.dateRDV || 0);
            });

            updateDashboardMetrics(filteredDeals);
            renderDeals(filteredDeals);
            
            if (filteredDeals.length === 0) {
                noDataMessage.textContent = "Aucun deal trouv√© pour cette p√©riode/filtre.";
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
            }
        }
        
        filterMonth.addEventListener('change', applyFiltersAndRender);
        filterStatus.addEventListener('change', applyFiltersAndRender);
        filterSource.addEventListener('change', applyFiltersAndRender);
        resetFiltersBtn.addEventListener('click', () => {
            filterMonth.value = 'current';
            filterStatus.value = 'all';
            filterSource.value = 'all';
            applyFiltersAndRender();
        });

        dealForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nomPrenom = document.getElementById('nomPrenom').value.trim();
            const source = document.getElementById('source').value;
            const newCommentText = newCommentField.value.trim();
            
            if (!nomPrenom || !source) {
                alertUser("Veuillez remplir les champs obligatoires.", 'warning');
                return;
            }

            const dealData = {
                id: editingId,
                nomPrenom,
                source,
                entrepreneur: document.getElementById('entrepreneur').value.trim(),
                email: document.getElementById('email').value.trim(),
                numero: document.getElementById('numero').value.trim(),
                dateRDV: document.getElementById('dateRDV').value,
                ghost: document.getElementById('ghost').checked,
                aFollowUp: document.getElementById('aFollowUp').checked,
                nonClose: document.getElementById('nonClose').checked,
                close: document.getElementById('close').checked,
                formation: document.getElementById('formation').value,
                prix: parseFloat(document.getElementById('prix').value) || 0,
                typePaiement: document.getElementById('typePaiement').value,
                mensualite: parseFloat(document.getElementById('mensualite').value) || 0,
                compta: document.getElementById('compta').checked,
                enregistrementCall: document.getElementById('enregistrementCall').value.trim(),
                newCommentText: editingId ? newCommentText : null,
                commentaireHistory: !editingId ? newCommentText : null 
            };

            let action = editingId ? 'UPDATE' : 'CREATE';
            const result = await fetchAppsScript(action, dealData);

            if (result.success) {
                alertUser(`Deal enregistr√© avec succ√®s.`, 'success');
                resetForm();
                await loadDeals(); 
            } else {
                alertUser(`√âchec: ${result.error}`, 'error');
            }
        });

        window.editDeal = async function(id) {
            const deal = allDealsCache.find(d => d.id === id);
            if (!deal) return;

            document.getElementById('nomPrenom').value = deal.nomPrenom || '';
            document.getElementById('source').value = deal.source || '';
            document.getElementById('email').value = deal.email || '';
            document.getElementById('numero').value = deal.numero || '';
            document.getElementById('dateRDV').value = deal.dateRDV || '';
            document.getElementById('entrepreneur').value = deal.entrepreneur || '';
            document.getElementById('ghost').checked = deal.ghost || false;
            document.getElementById('aFollowUp').checked = deal.aFollowUp || false;
            document.getElementById('nonClose').checked = deal.nonClose || false;
            
            // Gestion sp√©ciale pour CLOS√â
            const isClosed = deal.close || false;
            document.getElementById('close').checked = isClosed;
            
            document.getElementById('formation').value = deal.formation || '';
            document.getElementById('prix').value = deal.prix || '';
            document.getElementById('typePaiement').value = deal.typePaiement || '';
            document.getElementById('mensualite').value = deal.mensualite || '';
            document.getElementById('compta').checked = deal.compta || false;
            document.getElementById('enregistrementCall').value = deal.enregistrementCall || '';
            
            // Appel manuel pour afficher/masquer les champs en fonction du statut charg√©
            toggleClosingDetails();

            newCommentField.value = '';
            displayCommentHistory(deal.commentaireHistory);

            editingId = id;
            formTitle.textContent = `Modifier: ${deal.nomPrenom}`;
            submitText.textContent = 'Enregistrer';
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.deleteDeal = async function(id, nomPrenom) {
            if (!await showCustomConfirmation(`Supprimer "${nomPrenom}" ?`)) return;
            const result = await fetchAppsScript('DELETE', { id });
            if (result.success) {
                alertUser(`Supprim√©.`, 'success');
                if (editingId === id) resetForm();
                await loadDeals();
            } else {
                alertUser(`Erreur: ${result.error}`, 'error');
            }
        }
        
        cancelEditBtn.addEventListener('click', resetForm);

        function resetForm() {
            dealForm.reset();
            editingId = null;
            formTitle.textContent = 'Ajouter un Nouveau Deal';
            submitText.textContent = 'Ajouter le Deal';
            cancelEditBtn.classList.add('hidden');
            
            // R√©initialiser l'affichage des d√©tails closing
            toggleClosingDetails();
            
            newCommentField.placeholder = 'Ajouter une note...';
            document.getElementById('comment-history').classList.add('hidden');
        }

        function updateDashboardMetrics(deals) {
            metricTotal.textContent = deals.length;
            metricFollowUp.textContent = deals.filter(l => l.aFollowUp).length;
            metricClosed.textContent = deals.filter(l => l.close).length;
        }

        function renderDeals(deals) {
            dealsTableBody.innerHTML = '';
            if (deals.length === 0) return;

            deals.forEach(deal => {
                const isClosed = deal.close;
                const hasPastRDV = deal.dateRDV && isPastDate(deal.dateRDV);
                
                let rowBgClass = '';
                if (isClosed) rowBgClass = 'bg-green-50/50';
                else if (deal.aFollowUp && hasPastRDV) rowBgClass = 'bg-red-50/50'; 
                else if (hasPastRDV) rowBgClass = 'bg-yellow-50/50';
                
                const row = document.createElement('tr');
                row.className = `hover:bg-gray-100 transition duration-150 ${rowBgClass}`; 

                const dateRDVDisplay = deal.dateRDV ? `<span class="${hasPastRDV ? 'text-red-600 font-bold' : 'text-blue-600'}">${new Date(deal.dateRDV).toLocaleDateString('fr-FR')}</span>` : '<span class="text-gray-400 italic">Non d√©finie</span>';
                const dashIcon = '‚Äî';
                const flagsDisplay = `
                    <span class="p-1 rounded-full text-xs font-semibold ${deal.ghost ? 'bg-yellow-200 text-yellow-800' : 'bg-gray-100 text-gray-400'}" title="Ghost">${deal.ghost ? 'G' : dashIcon}</span>
                    <span class="p-1 rounded-full text-xs font-semibold ${deal.aFollowUp ? 'bg-indigo-200 text-indigo-800' : 'bg-gray-100 text-gray-400'}" title="√Ä Follow Up">${deal.aFollowUp ? 'F' : dashIcon}</span>
                    <span class="p-1 rounded-full text-xs font-semibold ${deal.close ? 'bg-green-200 text-green-800 font-bold' : 'bg-red-200 text-red-800'}" title="Clos√©">${deal.close ? 'C' : (deal.nonClose ? 'N' : dashIcon)}</span>
                `;
                
                const prixFormatte = deal.prix ? `${deal.prix.toLocaleString('fr-FR')} ‚Ç¨` : 'N/A';
                const entrepreneurDisplay = deal.entrepreneur ? `<div class="text-xs text-indigo-600 font-semibold mt-1">üè¢ ${deal.entrepreneur}</div>` : '';

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">
                        ${deal.nomPrenom}
                        <span class="text-xs text-gray-500 block">${deal.source}</span>
                        ${entrepreneurDisplay}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${dateRDVDisplay}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${deal.formation || 'N/A'}
                        <span class="font-bold text-blue-600 block">${prixFormatte}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">${deal.typePaiement || 'N/A'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-xs space-x-1">${flagsDisplay}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium flex space-x-2 justify-end items-center">
                        <button onclick="showHistoryModal('${deal.id}')" class="text-gray-500 hover:text-gray-900 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></button>
                        <button onclick="editDeal('${deal.id}')" class="text-blue-600 hover:text-blue-900 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-10l5 5m-5-5L3 17"></path></svg></button>
                        <button onclick="deleteDeal('${deal.id}', '${deal.nomPrenom.replace(/'/g, "\\'")}')" class="text-red-600 hover:text-red-900 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                `;
                dealsTableBody.appendChild(row);
            });
        }
        
        window.showHistoryModal = function(id) {
            const deal = allDealsCache.find(l => l.id === id);
            if (!deal) return;
            modalHistoryContent.textContent = deal.commentaireHistory || 'Aucun historique.';
            historyModal.classList.remove('hidden');
            historyModal.classList.add('flex');
        }

        closeModalBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
            historyModal.classList.remove('flex');
        });

        function displayCommentHistory(historyString) {
            const historyDiv = document.getElementById('comment-history');
            if (historyString) {
                historyDiv.classList.remove('hidden');
            } else {
                historyDiv.classList.add('hidden');
            }
        }

        function isPastDate(dateString) {
            if (!dateString) return false;
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            return new Date(dateString) < today;
        }

        function alertUser(message, type = 'info') {
            const id = 'toast-' + Date.now();
            const colorMap = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
            const div = document.createElement('div');
            div.id = id;
            div.className = `fixed top-4 right-4 ${colorMap[type]} text-white p-4 rounded-lg shadow-xl transform transition-all duration-300 opacity-0 translate-y-4 z-50`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => { div.classList.remove('opacity-0', 'translate-y-4'); div.classList.add('opacity-100', 'translate-y-0'); }, 10);
            setTimeout(() => { div.classList.add('opacity-0', 'translate-y-4'); div.addEventListener('transitionend', () => div.remove()); }, 5000);
        }

        function showCustomConfirmation(message) {
             return new Promise(resolve => {
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50';
                const modal = document.createElement('div');
                modal.className = 'bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-90 transition-all duration-300';
                modal.innerHTML = `<h3 class="text-lg font-bold mb-4 text-red-700">Confirmer</h3><p class="text-gray-700 mb-6">${message}</p><div class="flex justify-end space-x-3"><button id="cancel-modal" class="px-4 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 transition duration-150">Annuler</button><button id="confirm-modal" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150">Confirmer</button></div>`;
                backdrop.appendChild(modal);
                document.body.appendChild(backdrop);
                setTimeout(() => modal.classList.replace('scale-90', 'scale-100'), 10);
                const closeModal = () => { modal.classList.replace('scale-100', 'scale-90'); backdrop.classList.add('opacity-0'); backdrop.addEventListener('transitionend', () => backdrop.remove()); };
                document.getElementById('confirm-modal').onclick = () => { closeModal(); resolve(true); };
                document.getElementById('cancel-modal').onclick = () => { closeModal(); resolve(false); };
                backdrop.onclick = (e) => { if (e.target === backdrop) { closeModal(); resolve(false); } };
            });
        }

        loadDeals();
    </script>
</body>
</html>
